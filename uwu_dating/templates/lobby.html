{% extends 'base.html' %}

{% block extras %}
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
    <script>
        const socket = io({
        reconnection: true,
        reconnectionAttempts: 10000,
        reconnectionDelay: 1000,
    });
        socket.emit("hello", "{{ g.user.id }}");
        socket.emit("update");

        socket.on("join", function (data) {
            if (data.id !== "{{ g.user.id }}") {
                const userCardTemplate = `
    <div class="user-card" id="user-${data.id}">
        <h3 class="user-name">
            <span class="side-by-side">
                <span>${data.name}</span>
                <span>${Math.round(data.score * 100)} %</span>
            </span>
        </h3>
        <a href="/user/profile/${data.id}">uwu \></a>
    </div>
`;

                let found = false
                document.querySelectorAll(".user-card").forEach(card => {
                    if (card.id.split("-")[1] === `${data.id}`) {
                        found = true;
                    }
                })
                if (found) {
                    return
                }

                const userCard = document.createElement("div")
                userCard.innerHTML = userCardTemplate;

                document.getElementById("users").appendChild(userCard);
                document.getElementById('nobody').style.display = 'none';
            }
        });

        socket.on("leave", function (data) {
            document.getElementById(`user-${data.id}`).remove();
            if (document.getElementsByClassName('user-card').length === 0) {
                document.getElementById('nobody').style.display = 'block';
            }
        })

        socket.on("poke", function () {
            const poke = document.createElement("p")
            poke.className = 'new-poke'
            poke.textContent = 'new poke uwu';
            document.getElementById('new-things').appendChild(poke);
            socket.emit("update");
        })

        socket.on("message", function () {
            const message = document.createElement("p")
            message.className = 'new-message';
            message.textContent = 'new message, who is this';
            document.getElementById('new-things').appendChild(message);
            socket.emit("update");
        })

        socket.on("update", function (data) {
            document.getElementById(`count-unacked-pokes`).textContent = data.unacked_pokes
            document.getElementById('count-messages').textContent = data.messages
        })
    </script>
{% endblock %}

{% block title %}Lobby{% endblock %}

{% block content %}
    <h1>Welcome to The Lobby</h1>
    <p>see other beings that are currently also in The Lobby</p>
    <p>
        <span id="count-unacked-pokes">0</span> unacked pokes,
        <span id="count-messages">0</span> messages
    </p>
    <div class="column">
        <a href="/user/me">my profile (pokes, messages) ></a>
    </div>
    <div class="new-things" id="new-things">
    </div>
    <div id="users">
    </div>
    <h3 id="nobody">nobody here qwq</h3>
{% endblock %}